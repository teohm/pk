#!/usr/bin/env ruby

require 'thor'

class PkIgnoreFile
  PKIGNORE_NAMES = %w(pkignore .pkignore).freeze

  def initialize(path)
    @ignore_list = PKIGNORE_NAMES.dup
    PKIGNORE_NAMES.each do |filename|
      file = File.expand_path(File.join(path, filename))
      if File.exist? file
        @ignore_list = @ignore_list + File.open(file, 'r').read.split("\n")
        break
      end
    end
  end

  def ignore_file?(filename)
    ignore = false
    @ignore_list.each do |ignore_pattern|
      if File.fnmatch(ignore_pattern, filename, File::FNM_PATHNAME)
        ignore = true
        break
      end
    end
    ignore
  end
end

module Helper

  def init
    `mkdir -p ~/.pk/data/`
  end

  def all_members_of(team)
    pkignore = PkIgnoreFile.new("~/.pk/data/#{team}")
    [].tap do |list|
      `ls ~/.pk/data/#{team}`.split.each do |filename|
        list << filename unless pkignore.ignore_file?(filename)
      end
    end
  end
end

class Team < Thor
  include Helper

  desc "add NAME, GIT_URL", "add team repo via git clone"
  def add(name, git_url)
    init
    `git clone #{git_url} ~/.pk/data/#{name}`
  end

  desc "reload [TEAM]", "reload a team repo, or all teams if not specified"
  def reload(team=nil)
    init
    teams = Dir["#{ENV["HOME"]}/.pk/data/*/"].map{|f| File.basename(f) }
    teams = teams.select{|t| t == team} if team
    teams.each do |t|
      `cd ~/.pk/data/#{t} && git pull && cd -`
    end
  end

  desc "list [TEAM]", "list all team, or team members if team is specified"
  def list(team=nil)
    init
    if team
      all_members_of(team).each do |m|
        puts m
      end
    else
      `ls ~/.pk/data`.split.each do |t|
        puts t
      end
    end
  end

end

class Pk < Thor
  include Helper

  desc "keys TEAM [MEMBER1,MEMBER2,..]", "print public keys of members in a specific team"
  def keys(team, members=nil)
    init
    member_list = members ? members.split(',').compact : all_members_of(team)
    member_list.each do |member|
      puts `cat ~/.pk/data/#{team}/#{member}`
    end
  end

  desc "team", "manage teams"
  subcommand "team", Team
end

Pk.start
